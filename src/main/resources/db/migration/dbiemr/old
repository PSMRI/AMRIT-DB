CREATE DEFINER=`piramaldev`@`localhost` PROCEDURE `Pr_Stockdetail`(v_FromDate date, v_ToDate date,
v_facilityid int(11))
BEGIN

select 
C.Vanserialno ItemStockEntryID, C.ItemID, C.FacilityID, C.BatchNo, C.TotalQuantityReceived, C.UnitCostPrice, 
C.ExpiryDate, C.EntryType, C.ProviderServiceMapID, C.EntryDate, 
(C.OpeningStock+C.AdjustedQuantity_FromDate) as OpeningStock,
 C.AdjustedQuantity_FromDate,
 QuantityDispanced,

ITM.ItemName,
FAC.FacilityName,
ITMC.ItemCategoryName,
sum(if(SAItm.IsAdded = 0b1, ifnull(SAItm.AdjustedQuantity,0),-(ifnull(SAItm.AdjustedQuantity,0))) ) as AdjustedQuantity_ToDate,
sum(if(SAItm.IsAdded = 0b1, ifnull(SAItm.AdjustedQuantity,0),0) ) as AdjustedQuantity_ToDate_Receipt,
sum(if(SAItm.IsAdded = 0b1, 0,(ifnull(SAItm.AdjustedQuantity,0))) ) as AdjustedQuantity_ToDate_Issue ,
((C.OpeningStock)+(C.AdjustedQuantity_FromDate)-(QuantityDispanced)+
(sum(if(SAItm.IsAdded = 0b1, ifnull(SAItm.AdjustedQuantity,0),-(ifnull(SAItm.AdjustedQuantity,0))) ))) as ClosingStock

from

(select B.*,
sum(ifnull(ISEx.Quantity,0)) as QuantityDispanced,
(OpeningStock_temp) as OpeningStock -- +AdjustedQuantity_FromDate
from

(select A.*,
sum(if(SAItm.IsAdded = 0b1, ifnull(SAItm.AdjustedQuantity,0),-(ifnull(SAItm.AdjustedQuantity,0))) ) as AdjustedQuantity_FromDate
from
 
(select
ISE.vanid,
ISE.VanSerialNo,
ISE.ItemID,
ISE.FacilityID,
ISE.BatchNo,
ifnull(ISE.Quantity,0) as TotalQuantityReceived,
ISE.UnitCostPrice,
ISE.ExpiryDate,
ISE.EntryType,
ISE.ProviderServiceMapID,
ISE.CreatedDate as EntryDate,
  (ifnull(ISE.Quantity,0) - sum(ifnull(ISEx.Quantity,0))) as OpeningStock_temp
-- ISE.QuantityInHand as OpeningStock
FROM db_iemr.t_itemstockentry ISE
left join db_iemr.t_itemstockexit ISEx
 on ISE.VanSerialNo = ISEx.ItemStockEntryID and ISE.vanid=ISEx.vanid
 and date(ISEx.CreatedDate) <v_FromDate
 
where date(ISE.CreatedDate) <= v_ToDate

group by ISE.VanSerialNo,ISE.vanid
) A left join db_iemr.t_saitemmapping SAItm 
        on SAItm.ItemStockEntryID=A.VanSerialNo and SAItm.vanid=A.vanid
        and date(SAItm.CreatedDate) < v_FromDate 
        
group by A.VanSerialNo,A.Vanid
 ) B left join db_iemr.t_itemstockexit ISEx 
        on B.VanSerialNo = ISEx.ItemStockEntryID   and B.vanid=ISEx.vanid
        and date(ISEx.CreatedDate) >= v_FromDate  
        and date(ISEx.CreatedDate) <= v_ToDate
        
 group by B.VanSerialNo,B.Vanid
 ) C left join db_iemr.t_saitemmapping SAItm 
        on SAItm.ItemStockEntryID=C.VanSerialNo and SAItm.vanid=SAItm.vanid
        and date(SAItm.CreatedDate) >= v_FromDate 
        and date(SAItm.CreatedDate) <= v_ToDate
        
        Inner Join db_iemr.m_Item ITM on C.ItemID = ITM.ItemID
        Inner Join db_iemr.m_Facility FAC on C.FacilityID = FAC.FacilityID
        Inner join db_iemr.m_ItemCategory ITMC on ITM.ItemCategoryID = ITMC.ItemCategoryID
       -- where c.vanid is not null
         where c.facilityid=ifnull(v_facilityid,c.facilityid)
group by C.VanSerialNo,C.Vanid;
 

END