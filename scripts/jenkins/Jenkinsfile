pipeline {
    agent any
    
    parameters {
        string(
            name: 'PROD_DUMP_PATH',
            defaultValue: '/backup/production-dump.sql',
            description: 'Path to production SQL dump file'
        )
        string(
            name: 'UAT_DUMP_PATH',
            defaultValue: '/backup/uat-anonymized.sql',
            description: 'Output path for anonymized SQL dump'
        )
        string(
            name: 'REGISTRY_FILE',
            defaultValue: '',
            description: 'Custom registry YAML (optional, leave blank for default)'
        )
        string(
            name: 'LOOKUP_DB_PATH',
            defaultValue: './jenkins-lookup-cache',
            description: 'H2 lookup database path'
        )
        booleanParam(
            name: 'DRY_RUN',
            defaultValue: false,
            description: 'Dry run mode - validate only'
        )
        booleanParam(
            name: 'VERBOSE',
            defaultValue: true,
            description: 'Verbose output'
        )
    }
    
    environment {
        ANONYMIZATION_SALT = credentials('amrit-anonymization-salt')
        JAVA_HOME = tool name: 'JDK17'
        MAVEN_HOME = tool name: 'Maven3'
        PATH = "${JAVA_HOME}/bin:${MAVEN_HOME}/bin:${env.PATH}"
    }
    
    stages {
        stage('Preparation') {
            steps {
                echo '========================================='
                echo ' AMRIT Database Anonymization Pipeline'
                echo '========================================='
                echo ''
                echo "Input:  ${params.PROD_DUMP_PATH}"
                echo "Output: ${params.UAT_DUMP_PATH}"
                echo "Lookup: ${params.LOOKUP_DB_PATH}"
                echo "Dry Run: ${params.DRY_RUN}"
                echo ''
                
                script {
                    // Check if input file exists
                    if (!fileExists(params.PROD_DUMP_PATH)) {
                        error "Production dump file not found: ${params.PROD_DUMP_PATH}"
                    }
                    
                    // Get file size
                    def fileSize = sh(
                        script: "du -h '${params.PROD_DUMP_PATH}' | cut -f1",
                        returnStdout: true
                    ).trim()
                    
                    echo "Input file size: ${fileSize}"
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'Building AMRIT Anonymization Tool...'
                
                dir('AMRIT-DB') {
                    sh 'mvn clean package -DENV_VAR=local -DskipTests'
                }
                
                script {
                    if (!fileExists('AMRIT-DB/target/Amrit-DB-1.0.0.war')) {
                        error "Build failed - JAR not found"
                    }
                }
                
                echo 'Build complete'
            }
        }
        
        stage('Validate') {
            steps {
                echo 'Validating configuration...'
                
                dir('AMRIT-DB') {
                    script {
                        def validateCmd = [
                            'java',
                            '-Xmx4g',
                            '-jar', 'target/Amrit-DB-1.0.0.war',
                            'anonymize',
                            '--input', params.PROD_DUMP_PATH,
                            '--output', params.UAT_DUMP_PATH,
                            '--lookup', params.LOOKUP_DB_PATH,
                            '--salt', env.ANONYMIZATION_SALT,
                            '--dry-run'
                        ]
                        
                        if (params.REGISTRY_FILE) {
                            validateCmd += ['--registry', params.REGISTRY_FILE]
                        }
                        
                        def exitCode = sh(
                            script: validateCmd.join(' '),
                            returnStatus: true
                        )
                        
                        if (exitCode != 0) {
                            error "Validation failed with exit code: ${exitCode}"
                        }
                    }
                }
                
                echo 'Validation passed'
            }
        }
        
        stage('Anonymize') {
            when {
                expression { params.DRY_RUN == false }
            }
            steps {
                echo 'Starting anonymization...'
                
                dir('AMRIT-DB') {
                    script {
                        def anonymizeCmd = [
                            'java',
                            '-Xmx4g',
                            '-Xms1g',
                            '-jar', 'target/Amrit-DB-1.0.0.war',
                            'anonymize',
                            '--input', params.PROD_DUMP_PATH,
                            '--output', params.UAT_DUMP_PATH,
                            '--lookup', params.LOOKUP_DB_PATH,
                            '--salt', env.ANONYMIZATION_SALT
                        ]
                        
                        if (params.REGISTRY_FILE) {
                            anonymizeCmd += ['--registry', params.REGISTRY_FILE]
                        }
                        
                        if (params.VERBOSE) {
                            anonymizeCmd += '--verbose'
                        }
                        
                        def startTime = System.currentTimeMillis()
                        
                        def exitCode = sh(
                            script: anonymizeCmd.join(' '),
                            returnStatus: true
                        )
                        
                        def endTime = System.currentTimeMillis()
                        def duration = (endTime - startTime) / 1000
                        
                        if (exitCode != 0) {
                            error "Anonymization failed with exit code: ${exitCode}"
                        }
                        
                        echo "Anonymization completed in ${duration} seconds"
                    }
                }
            }
        }
        
        stage('Verify Output') {
            when {
                expression { params.DRY_RUN == false }
            }
            steps {
                echo 'Verifying output file...'
                
                script {
                    if (!fileExists(params.UAT_DUMP_PATH)) {
                        error "Output file not created: ${params.UAT_DUMP_PATH}"
                    }
                    
                    def outputSize = sh(
                        script: "du -h '${params.UAT_DUMP_PATH}' | cut -f1",
                        returnStdout: true
                    ).trim()
                    
                    echo "Output file size: ${outputSize}"
                    
                    // Basic sanity check - file should be > 0 bytes
                    def fileSize = sh(
                        script: "stat -c%s '${params.UAT_DUMP_PATH}'",
                        returnStdout: true
                    ).trim().toLong()
                    
                    if (fileSize == 0) {
                        error "Output file is empty"
                    }
                    
                    echo "Output verification passed"
                }
            }
        }
        
        stage('Archive') {
            when {
                expression { params.DRY_RUN == false }
            }
            steps {
                echo 'Archiving anonymized dump...'
                
                archiveArtifacts artifacts: params.UAT_DUMP_PATH, 
                                 allowEmptyArchive: false
                
                echo 'Artifact archived successfully'
            }
        }
    }
    
    post {
        success {
            echo ''
            echo '========================================='
            echo ' Anonymization Pipeline: SUCCESS'
            echo '========================================='
            echo ''
            
            script {
                if (params.DRY_RUN) {
                    echo 'Dry run completed - validation passed'
                } else {
                    echo "Anonymized dump available at: ${params.UAT_DUMP_PATH}"
                    echo "Lookup cache at: ${params.LOOKUP_DB_PATH}"
                }
            }
        }
        
        failure {
            echo ''
            echo '========================================='
            echo ' Anonymization Pipeline: FAILED'
            echo '========================================='
            echo ''
            echo 'Check console output for error details'
        }
        
        always {
            // Clean up workspace if needed
            cleanWs(
                deleteDirs: true,
                disableDeferredWipeout: true,
                notFailBuild: true,
                patterns: [
                    [pattern: 'AMRIT-DB/target', type: 'INCLUDE']
                ]
            )
        }
    }
}
